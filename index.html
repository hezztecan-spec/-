/*
 * ESP32 MANIPULATOR - BLE Control
 * Web interface on GitHub Pages + BLE connection
 */

#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>
#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>

// BLE UUID
#define SERVICE_UUID        "0000ffe0-0000-1000-8000-00805f9b34fb"
#define CHARACTERISTIC_UUID "0000ffe1-0000-1000-8000-00805f9b34fb"

// I2C pins
#define SDA_PIN 18
#define SCL_PIN 17

// Objects
Adafruit_PWMServoDriver pwm = Adafruit_PWMServoDriver();
BLEServer* pServer = NULL;
BLECharacteristic* pCharacteristic = NULL;

// Servo channels
const int SERVO_BASE = 0;
const int SERVO_ARM = 1;
const int SERVO_GRIPPER = 2;

// Servo parameters
#define SERVOMIN  150
#define SERVOMAX  600
#define SERVO_FREQ 50

// Current angles
int angleBase = 90;
int angleArm = 90;
int angleGripper = 90;

bool deviceConnected = false;

// Convert angle to pulse
uint16_t angleToPulse(int angle) {
  angle = constrain(angle, 0, 180);
  return map(angle, 0, 180, SERVOMIN, SERVOMAX);
}

// Set servo angle
void setServoAngle(uint8_t channel, int angle) {
  uint16_t pulse = angleToPulse(angle);
  pwm.setPWM(channel, 0, pulse);
}

// Parse command: "B:90,A:45,G:120"
void parseCommand(String data) {
  int bIndex = data.indexOf("B:");
  int aIndex = data.indexOf("A:");
  int gIndex = data.indexOf("G:");
  
  if (bIndex != -1 && aIndex != -1 && gIndex != -1) {
    angleBase = data.substring(bIndex + 2, aIndex - 1).toInt();
    angleArm = data.substring(aIndex + 2, gIndex - 1).toInt();
    angleGripper = data.substring(gIndex + 2).toInt();
    
    angleBase = constrain(angleBase, 0, 180);
    angleArm = constrain(angleArm, 0, 180);
    angleGripper = constrain(angleGripper, 0, 180);
    
    setServoAngle(SERVO_BASE, angleBase);
    setServoAngle(SERVO_ARM, angleArm);
    setServoAngle(SERVO_GRIPPER, angleGripper);
    
    Serial.print("Position - Base: ");
    Serial.print(angleBase);
    Serial.print(" Arm: ");
    Serial.print(angleArm);
    Serial.print(" Gripper: ");
    Serial.println(angleGripper);
  }
}

// BLE Server Callbacks
class MyServerCallbacks: public BLEServerCallbacks {
    void onConnect(BLEServer* pServer) {
      deviceConnected = true;
      Serial.println("Client connected!");
      
      // Welcome gesture
      setServoAngle(SERVO_GRIPPER, 120);
      delay(200);
      setServoAngle(SERVO_GRIPPER, 60);
      delay(200);
      setServoAngle(SERVO_GRIPPER, 90);
    };

    void onDisconnect(BLEServer* pServer) {
      deviceConnected = false;
      Serial.println("Client disconnected");
      
      // Reset position
      setServoAngle(SERVO_BASE, 90);
      setServoAngle(SERVO_ARM, 90);
      setServoAngle(SERVO_GRIPPER, 90);
      
      delay(500);
      pServer->startAdvertising();
      Serial.println("Waiting for new connection...");
    }
};

// BLE Characteristic Callbacks
class MyCallbacks: public BLECharacteristicCallbacks {
    void onWrite(BLECharacteristic *pCharacteristic) {
      std::string value = pCharacteristic->getValue();

      if (value.length() > 0) {
        String receivedData = "";
        for (int i = 0; i < value.length(); i++) {
          receivedData += value[i];
        }
        parseCommand(receivedData);
      }
    }
};

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("====================================");
  Serial.println("  ESP32 MANIPULATOR - BLE CONTROL  ");
  Serial.println("====================================");
  Serial.println();
  
  // Initialize I2C and PCA9685
  Serial.println("-> Initializing servos...");
  Wire.begin(SDA_PIN, SCL_PIN);
  
  Wire.beginTransmission(0x40);
  byte error = Wire.endTransmission();
  
  if (error == 0) {
    Serial.println("OK PCA9685 found");
  } else {
    Serial.println("ERROR PCA9685 not found!");
  }
  
  pwm.begin();
  pwm.setPWMFreq(SERVO_FREQ);
  delay(100);
  
  Serial.println("-> Setting initial position...");
  setServoAngle(SERVO_BASE, 90);
  setServoAngle(SERVO_ARM, 90);
  setServoAngle(SERVO_GRIPPER, 90);
  Serial.println("OK Servos ready");
  Serial.println();
  
  // Initialize BLE
  Serial.println("-> Initializing Bluetooth...");
  BLEDevice::init("ESP32_Manipulator");
  
  pServer = BLEDevice::createServer();
  pServer->setCallbacks(new MyServerCallbacks());
  
  BLEService *pService = pServer->createService(SERVICE_UUID);
  
  pCharacteristic = pService->createCharacteristic(
                      CHARACTERISTIC_UUID,
                      BLECharacteristic::PROPERTY_READ   |
                      BLECharacteristic::PROPERTY_WRITE  |
                      BLECharacteristic::PROPERTY_NOTIFY |
                      BLECharacteristic::PROPERTY_INDICATE
                    );
  
  pCharacteristic->addDescriptor(new BLE2902());
  pCharacteristic->setCallbacks(new MyCallbacks());
  
  pService->start();
  
  BLEAdvertising *pAdvertising = BLEDevice::getAdvertising();
  pAdvertising->addServiceUUID(SERVICE_UUID);
  pAdvertising->setScanResponse(false);
  pAdvertising->setMinPreferred(0x0);
  BLEDevice::startAdvertising();
  
  Serial.println("OK Bluetooth started!");
  Serial.println();
  Serial.println("====================================");
  Serial.println("  Device: ESP32_Manipulator        ");
  Serial.println("  Open website and connect         ");
  Serial.println("====================================");
  Serial.println();
  Serial.println("Waiting for connection...");
}

void loop() {
  delay(20);
}
